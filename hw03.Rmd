---
title: "hw03"
author: Mielle
output: github_document

---

 > Pick at least three of the tasks below (in the “Task menu” section) and attack each with a table and figure. For each table, make sure to include a relevant figure! Note that:

> dplyr should be your data manipulation tool
ggplot2 should be your visualization tool
Make observations about what your tables/figures show and about the process.

> Also useful for you to add to your “cheat sheet” are notes on difficulties/oddities. For example, which figures are easy/hard to make, which data formats make better inputs for plotting functions vs. for human-friendly tables.

> If relevant, give credit to your sources, whether it’s a blog post, a fellow student, an online tutorial, etc. This is also valuable “cheat sheet” info for future-you.


Relax about the following things:

Tidying/reshaping is NOT your assignment. Many of your tables will be awkwardly shaped in the report. That’s OK.
Table beauty is not a big deal. Simply printing to “screen” is fine. You could also try the knitr::kable() function. Assuming my_df is a data.frame, here’s an R chunk that should print it as a decent-looking table:
``{r results = 'asis'}
knitr::kable(my_df)
``
For all things, graphical and tabular, if you’re dissatisfied with a result, discuss the problem, what you’ve tried and move on.
Your figure does not have to depict every single number from the data aggregation result. Use your judgement. It just needs to complement the table, add context, and allow for some sanity checking both ways.

## MENU

- Get the maximum and minimum of GDP per capita for all continents.

- Look at the spread of GDP per capita within the continents.

- Compute a trimmed mean of life expectancy for different years. Or a weighted mean, weighting by population. Just try something other than the plain vanilla mean.

- How is life expectancy changing over time on different continents?

- Report the absolute and/or relative abundance of countries with low life expectancy over time by continent: Compute some measure of worldwide life expectancy – you decide – a mean or median or some other quantile or perhaps your current age. Then determine how many countries on each continent have a life expectancy less than this benchmark, for each year.

- Find countries with interesting stories. Open-ended and, therefore, hard. Promising but unsuccessful attempts are encouraged. This will generate interesting questions to follow up on in class.

## Getting started
```{r load packages}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(gapminder))
suppressPackageStartupMessages(library(scales))

```



## How is life expectancy changing over time on different continents?

#### Using the mean and median to compare life expectancy 

```{r lifeExp over time}
lifetime <- gapminder %>% 
  group_by(continent, year) %>% 
  summarize(mnlife = mean(lifeExp), mdlife = median(lifeExp))

lifetime
```

Now, is it better to use the mean or median to represent this data? Let's check if the data is normally distributed. 

```{r histogram of life expectancy}
ggplot(gapminder, aes(lifeExp)) +
  geom_histogram(binwidth = 1, fill = "dark blue") +
  xlab("Count") +
  ylab("Life expectancy") +
  ggtitle("Frequency distribution of global life expectancy")

```

It's pretty clear our data isn't normally distributed, so it's more appropriate to use the median to represent life expectancy. 

#### Plotting global change in median life expectancy over time

First, we can plot median life expectancy for 1952 and 2007, and compare those. 

```{r 1952 median life expectancy (bar graph)}
lifetime %>% 
  filter(year == 1952) %>% 
  ggplot(aes(continent, mdlife, fill = continent)) +
  geom_col() +  
  scale_fill_brewer(palette = "Dark2") +
  xlab("Continent") +
  ylab("Median life expectancy") +
  ggtitle("Worldwide life expectancy, 1952")
```
In 1952, median life expectancy for Oceania and Europe was fairly similar and at the high end, Africa and Asia similar and at the low end, and the Americas had a median somewhere in between. 


```{r 2007 median life expectancy (bar graph)}
lifetime %>% 
  filter(year == 2007) %>% 
  ggplot(aes(continent, mdlife, fill = continent)) +
  geom_col() +  
  scale_fill_brewer(palette = "Dark2") +
  xlab("Continent") +
  ylab("Median life expectancy") +
  ggtitle("Worldwide life expectancy, 2007")
```

Looks like in 2007 Oceania, Europe, Asia, and the Americas are fairly close for median life expectancy with Africa close to 20 years lower than the rest. 


Let's check out the change in median life expectancy from 1952 to 2007. 

```{r change in mdlife 52 - 07}
gapminder %>% 
  group_by(continent, year) %>% 
  summarize(mdlife = median(lifeExp)) %>% 
  filter(year == 2007 | year == 1952) %>% 
  mutate(change = max(mdlife) - min(mdlife)) %>% 
  filter(year == 2007)

```


The graph below shows median life expectancy over time for each continent. Because ggplot2 doesn't group variables the way that dplyr does, you'll notice that I wasn't always able to directly pipe my tables created with dplyr into ggplot for visualization-- sometimes, I had to go about it a different way in order to graph the same thing. I would have liked to add another line with global median life expectancy, but couldn't get it to work. 


```{r md lifeExp over time}
ggplot(lifetime, aes(year, mdlife, color = continent)) +
  geom_line() +
  scale_color_brewer(palette = "Dark2") +
  xlab("Year") +
  ylab("Median life expectancy") +
  ggtitle("Worldwide life expectancy, 1952 - 2007")
    
```

Looks like all continents generally have a trend of increasing life expectancy over time, with Europe and Oceania following a similar trend and maintaining the highest median life expectancy. Asia and the Americas have a more dramatic increase over time, starting much lower than Europe and Oceania but closing the gap to within about five years by 2007. Median life expectancy in Africa is the lowest throughout, with a less dramatic gain over time-- it appears that the gap between Africa and the rest of the continents has widened over time. 


#### Plotting global change in life expectancy: bar graph
  
Another way to look at change in life expectancy is to calculate the diffence in life expectancy between 1952 and 2007 for each continent. 

You'll notice in the table below that I've gone about this in a fairly messy way. Rather than subtracting the life expectancy 1952 from the life expectancy in 2007, I took advantage of the fact that it increased for every continent and simply filtered for the desired years and then subtracte the maximum median life expectancy from the minimum by continent. Quick and dirty, but not ideal for replicating this if the data were different. 

```{r calculate increase in life expectancy }
lifeincr <- gapminder %>% 
  group_by(continent, year) %>% 
  summarize(mdlife = median(lifeExp)) %>% 
  filter(year == 2007 | year == 1952) %>% 
  mutate(change = max(mdlife) - min(mdlife)) %>% 
  filter(year == 2007)
  
lifeincr

```

Here is the table above, represented as a bar graph. Asia had the largest increase in median life expectancy by far, with an almost 30-year gain. Oceania and Europe made the smallest gains, but as we already know that those continents have maintained the highest median life expectancy, their lack of gain isn't necessarily an indicator of anything negative. This is a great example of why it's important to examine data in more than one way-- if we only had this bar graph to analyze, our takeaway for Oceania and Europe would probably be pretty different. 

```{r}
ggplot(lifeincr, aes(continent, change, fill = continent)) +
  geom_col() +
  scale_fill_brewer(palette = "Dark2") +
  xlab("Continent") +
  ylab("Change in life expectancy") +
  ggtitle("Worldwide change in life expectancy, 1952 - 2007")
```




## Look at the min + max of GDP per capita within the continents

make bar graph with min + max + median GDP on each continent (figure out how to get into ggplot as can't pipe it!)

###### Boxplot 
We can use a boxplot to examine the minimum, maximum, and median values of GP per capita for each continent. 

```{r continent gdppercap boxplot}
gdp <- ggplot(gapminder, aes(continent, gdpPercap, fill = continent))

gdp +
  geom_boxplot() +
  scale_y_log10() +
  scale_fill_brewer(palette = "Dark2") +
  xlab("Continent") +
  ylab("GDP per capita")
```



```{r}
#geom_col for stacked bar graph
```

```{r}
minmax <- gapminder %>% 
  group_by(continent) %>% 
  summarise(min = min(gdpPercap), md = median(gdpPercap), max = max(gdpPercap)) 

minmax

```

Let's see a graph of the minimum GDP per capita value for each continent. 

```{r}
ggplot(minmax, aes(continent, min, fill = continent)) +
  geom_col() +
  scale_fill_brewer(palette = "Dark2") +
  ggtitle("Minimum GDP per capita by continent, 1952-2007") +
  xlab("Continent") +
  ylab("GDP per capita value")
```

Now, a graph of the maximum GDP per capita value for each continent. 

```{r}
ggplot(minmax, aes(continent, max, fill = continent)) +
  geom_col() +  
  ggtitle("Maximum GDP per capita by continent, 1952-2007") +
  scale_fill_brewer(palette = "Dark2") +
  xlab("Continent") +
  ylab("GDP per capita value")
```


## Find countries with interesting stories 

#### Correlation of GDP per capita and life expectancy

###### Scatterplot

First, let's look at the relationship between GDP per capita and life expectancy, using a basic scatterplot. 
```{r scatterplot of gdpPercap + lifeExp}
ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent, alpha = 0.7)) +
  geom_point() +
  scale_x_log10() +
  scale_color_brewer(palette = "Dark2") +
  xlab("GDP per capita") +
  ylab("Life expectancy") +
  ggtitle("Life expectancy vs. GDP per capita")

```


From this scatter plot, we can see that typically, GDP per capita and life expectancy appear positively correlated (as one increases, the other increases). Is there a country where this does not hold true? Can we get GDP increase with life expectancy decrease? 

#### Simultaneous GDP per capita increase and life expectancy decrease

Calculate the rate of change in life expectancy and GDP per capita between observations for each country.

```{r Change in lifeExp and gdpPercap}
change <- gapminder %>% 
  group_by(country) %>% 
  mutate(gdpchange = gdpPercap - lag(gdpPercap)) %>% 
  mutate(lifechange = lifeExp - lag(lifeExp)) %>% 
  transmute(gdpchange, lifechange, year)

change
```
 

Select observations where GDP remained the same or increased, and life expectancy decreased. 

```{r gdp up, lifeExp down}
change %>% 
  filter(gdpchange >= 0, lifechange < 0)
```

Out of the entire dataset, this has only occured 54 times! Our assumption that GDP per capita and life expectancy will increase together was largely correct, with a few exceptions. 


# having trouble graphing because ggplot2 doesn't group the way that dplyr does
change %>% 
  filter(gdpchange >= 0, lifechange < 0) %>% 
  ggplot(aes(gdpchange, lifechange)) +
  geom_bar(aes(stat = identity, position = dodge))
  

We can tell that this phenomena is rare, but let's see how rare it actually is.
RELATIVE FREQUENCY? would need to filter out years that have NAs and then take the 54 instances out of that. 
```{r}

```

#### Simultaneous population increase and life expectancy decrease

Now, let's see if population growth and life expectancy sometimes change in opposite directions. 

```{r pop up, lifeExp down}
popup <-gapminder %>% 
  group_by(country) %>% 
  mutate(popchange = pop - lag(pop)) %>% 
  mutate(lifechange = lifeExp - lag(lifeExp)) %>% 
  filter(popchange >= 0, lifechange < 0) %>% 
  transmute(popchange, lifechange, year, continent)

popup
```

```{r}
ggplot(popup, aes(continent, fill = continent)) +
  geom_bar() +
  scale_fill_brewer(palette = "Dark2") +
  xlab("Continent") +
  ylab("Count") +
  ggtitle("Frequency of instances of increasing population and decreasing life expectancy")
```


Yes, population increases do happen concurrently with life expectancy decreases, and at almost twice the rate as the same phenomenon with GDP per capita and population. Perhaps increasing population means more pressure on resources, which decreases the health and therefor life expectancy of the population. This phenomenon is most common in countries from Africa. 




#### Simultaneous population decrease and life expectancy increase 

Now, let's check the opposite-- do life expectancy increases ever coincide with population decreases?

```{r pop down, lifeExp up}
popdown <- gapminder %>% 
  group_by(country) %>% 
  mutate(popchange = pop - lag(pop)) %>% 
  mutate(lifechange = lifeExp - lag(lifeExp)) %>% 
  filter(popchange < 0, lifechange >= 0) %>% 
  transmute(popchange, lifechange, year, continent)

popdown
```

Occasionally, yes! With only 36 observations, this is our rarest find yet.

Let's check out a scatter plot to see how our observations vary in population and life expectancy change. 

```{r scatter plot of lifechange, popchange}
ggplot(popdown, aes(lifechange, popchange, color = continent, label = country)) +
  scale_color_brewer(palette = "Dark2") +
  geom_point() +
  xlab("Change in life expectancy") +
  ylab("Change in population") +
  geom_text(aes(label = ifelse (lifechange > 3 | popchange < -1500000, as.character(country), '')), vjust = -1, hjust = .7) +
  geom_text(aes(label = ifelse (lifechange > 3 | popchange < -1500000, as.character(year), '')), vjust = .5, hjust = 1.2)
  

```




 Now, let's explore if there's a spatial pattern. 

```{r count countries by continent}
popdown %>% 
  group_by(continent) %>% 
  count(continent)

```

Let's do a quick visualization to compare. 
```{r popdown histogram by continent}
ggplot(popdown, aes(continent, fill = continent)) +
  geom_bar() +
  scale_fill_brewer(palette = "Dark2") +
  xlab("Continent") +
  ylab("Count") +
  ggtitle("Frequency of instances of increasing life expectancy and decreasing population")
```

Yes, even without mapping there is a clear spatial pattern-- the vast majority of observations where population decreases as life expectancy increases are in Europe. Ideally, we would look at the relative frequency of each continent in the dataset to see if there is truly a disproportionate number of observations. However, we know that Europe does not have significantly more countries than all the other continents, so even without a statistical comparison it's pretty clear there is a spatial dimension. 




Let's see if there's a temporal pattern as well. This isn't working though! 

```{r popdown histogram by year}
popdown %>% 
  count(year) %>% 
  arrange(year)

ggplot(popdown, aes(year)) +
  geom_bar(fill = "dark blue") +
  xlab("Year") +
  ylab("Count") +
  ggtitle("Temporal pattern of increasing life expectancy and decreasing population ")
```


Yes, there is a clear temporal pattern to this phenomenon. It appears that over time, increasing life expectancy combined with decreasing population has become more frequent.


## Special thanks to (GET THIS TO WORK)
- (Bar graph help)[https://ggplot2.tidyverse.org/reference/geom_bar.html]

- [Labelling points in scatterplot) (https://stackoverflow.com/questions/15624656/label-points-in-geom-point)

